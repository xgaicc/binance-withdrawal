{"id":"binance-withdrawal-m2e","title":"Binance Master Withdrawal Service","description":"A microservice that automatically forwards funds from a Binance master account to configured external wallets, enabling sub-accounts to effectively perform external withdrawals through an internal transfer → auto-forward pattern.","status":"open","priority":2,"issue_type":"epic","owner":"snichols@therealm.io","created_at":"2026-01-21T14:38:24.966851644-06:00","created_by":"Stephen Nichols","updated_at":"2026-01-21T14:38:24.966851644-06:00","external_ref":"prd:./tasks/prd-product-requirements-document-binance-master-withdrawal-service.md","labels":["feature","ralph"]}
{"id":"binance-withdrawal-m2e.1","title":"US-6: BoltDB Persistence","description":"As the withdrawal service, I want to persist transfer records in BoltDB so that state survives restarts and enables auditing.\n\n## Acceptance Criteria\n- [ ] Store TransferRecord by tranId in transfers/ bucket\n- [ ] Maintain by-status/ index for status queries\n- [ ] Maintain by-time/ index for time-ordered listing\n- [ ] Update indexes atomically with record updates\n- [ ] go build ./... passes\n- [ ] go test ./... passes","status":"closed","priority":1,"issue_type":"task","owner":"snichols@therealm.io","created_at":"2026-01-21T14:38:36.749488177-06:00","created_by":"Stephen Nichols","updated_at":"2026-01-21T14:48:52.438507105-06:00","closed_at":"2026-01-21T14:48:52.438507105-06:00","close_reason":"Completed by agent","labels":["ralph","task"],"dependencies":[{"issue_id":"binance-withdrawal-m2e.1","depends_on_id":"binance-withdrawal-m2e","type":"parent-child","created_at":"2026-01-21T14:38:36.752056822-06:00","created_by":"Stephen Nichols"}]}
{"id":"binance-withdrawal-m2e.10","title":"US-12: Error Handling - Permanent Errors","description":"As the withdrawal service, I want to fail permanently on unrecoverable errors so that issues requiring human intervention are surfaced.\n\n## Acceptance Criteria\n- [ ] Mark as FAILED with error message for:\n  - Sub-account not configured\n  - Asset not configured for sub-account\n  - Invalid destination address\n  - Asset not supported for withdrawal\n  - Amount below minimum withdrawal\n- [ ] Require manual intervention to resolve\n- [ ] go build ./... passes\n- [ ] go test ./... passes","status":"open","priority":2,"issue_type":"task","owner":"snichols@therealm.io","created_at":"2026-01-21T14:39:28.266798506-06:00","created_by":"Stephen Nichols","updated_at":"2026-01-21T14:39:28.266798506-06:00","labels":["ralph","task"],"dependencies":[{"issue_id":"binance-withdrawal-m2e.10","depends_on_id":"binance-withdrawal-m2e","type":"parent-child","created_at":"2026-01-21T14:39:28.267880361-06:00","created_by":"Stephen Nichols"},{"issue_id":"binance-withdrawal-m2e.10","depends_on_id":"binance-withdrawal-m2e.2","type":"blocks","created_at":"2026-01-21T14:40:27.27737375-06:00","created_by":"Stephen Nichols"},{"issue_id":"binance-withdrawal-m2e.10","depends_on_id":"binance-withdrawal-m2e.3","type":"blocks","created_at":"2026-01-21T14:40:27.323818242-06:00","created_by":"Stephen Nichols"}]}
{"id":"binance-withdrawal-m2e.11","title":"US-9: HTTP Monitoring Interface","description":"As an operator, I want HTTP endpoints for monitoring and manual intervention so that I can observe service status and retry failed transfers.\n\n## Acceptance Criteria\n- [ ] GET /health - Health check\n- [ ] GET /status - Service status and metrics\n- [ ] GET /transfers - List recent transfers with filters\n- [ ] GET /transfers/:tranId - Get specific transfer details\n- [ ] POST /transfers/:tranId/retry - Manually retry a failed transfer\n- [ ] go build ./... passes\n- [ ] go test ./... passes","status":"open","priority":3,"issue_type":"task","owner":"snichols@therealm.io","created_at":"2026-01-21T14:39:33.507627248-06:00","created_by":"Stephen Nichols","updated_at":"2026-01-21T14:39:33.507627248-06:00","labels":["ralph","task"],"dependencies":[{"issue_id":"binance-withdrawal-m2e.11","depends_on_id":"binance-withdrawal-m2e","type":"parent-child","created_at":"2026-01-21T14:39:33.509701969-06:00","created_by":"Stephen Nichols"},{"issue_id":"binance-withdrawal-m2e.11","depends_on_id":"binance-withdrawal-m2e.1","type":"blocks","created_at":"2026-01-21T14:40:31.41406963-06:00","created_by":"Stephen Nichols"},{"issue_id":"binance-withdrawal-m2e.11","depends_on_id":"binance-withdrawal-m2e.2","type":"blocks","created_at":"2026-01-21T14:40:31.469036169-06:00","created_by":"Stephen Nichols"}]}
{"id":"binance-withdrawal-m2e.12","title":"US-10: Prometheus Metrics","description":"As an operator, I want Prometheus metrics exposed so that I can monitor service health and performance.\n\n## Acceptance Criteria\n- [ ] binance_withdrawal_transfers_detected_total{sub_account, asset} - Counter\n- [ ] binance_withdrawal_forwards_total{sub_account, asset, status} - Counter\n- [ ] binance_withdrawal_forward_latency_seconds{asset} - Histogram\n- [ ] binance_withdrawal_pending_count - Gauge\n- [ ] binance_withdrawal_errors_total{error_type} - Counter\n- [ ] go build ./... passes\n- [ ] go test ./... passes","status":"open","priority":3,"issue_type":"task","owner":"snichols@therealm.io","created_at":"2026-01-21T14:39:38.934750123-06:00","created_by":"Stephen Nichols","updated_at":"2026-01-21T14:39:38.934750123-06:00","labels":["ralph","task"],"dependencies":[{"issue_id":"binance-withdrawal-m2e.12","depends_on_id":"binance-withdrawal-m2e","type":"parent-child","created_at":"2026-01-21T14:39:38.936585833-06:00","created_by":"Stephen Nichols"},{"issue_id":"binance-withdrawal-m2e.12","depends_on_id":"binance-withdrawal-m2e.2","type":"blocks","created_at":"2026-01-21T14:40:34.842260347-06:00","created_by":"Stephen Nichols"}]}
{"id":"binance-withdrawal-m2e.13","title":"US-13: Audit Logging","description":"As an operator, I want comprehensive audit logging of all forwarding actions so that I have a complete trail for compliance and debugging.\n\n## Acceptance Criteria\n- [ ] Log at WARN level: WITHDRAWAL_INITIATED: tranId, asset, amount, dest\n- [ ] Log at WARN level: WITHDRAWAL_COMPLETED: tranId, txid, fee\n- [ ] Include timestamps in all log entries\n- [ ] Support JSON log format for structured logging\n- [ ] go build ./... passes\n- [ ] go test ./... passes","status":"open","priority":3,"issue_type":"task","owner":"snichols@therealm.io","created_at":"2026-01-21T14:39:44.681115543-06:00","created_by":"Stephen Nichols","updated_at":"2026-01-21T14:39:44.681115543-06:00","labels":["ralph","task"],"dependencies":[{"issue_id":"binance-withdrawal-m2e.13","depends_on_id":"binance-withdrawal-m2e","type":"parent-child","created_at":"2026-01-21T14:39:44.683154897-06:00","created_by":"Stephen Nichols"},{"issue_id":"binance-withdrawal-m2e.13","depends_on_id":"binance-withdrawal-m2e.2","type":"blocks","created_at":"2026-01-21T14:40:38.472993369-06:00","created_by":"Stephen Nichols"}]}
{"id":"binance-withdrawal-m2e.2","title":"US-5: Transfer State Machine","description":"As the withdrawal service, I want to track transfer state through a defined lifecycle so that processing status is always known.\n\n## Acceptance Criteria\n- [ ] States: UNKNOWN → PENDING → FORWARDED → COMPLETED (or FAILED)\n- [ ] PENDING: Recorded, withdrawal not yet initiated\n- [ ] FORWARDED: Withdrawal API succeeded, have Binance refId\n- [ ] COMPLETED: External withdrawal confirmed on-chain\n- [ ] FAILED: Permanent failure (e.g., invalid address, unconfigured destination)\n- [ ] go build ./... passes\n- [ ] go test ./... passes","status":"closed","priority":1,"issue_type":"task","owner":"snichols@therealm.io","created_at":"2026-01-21T14:38:42.216962185-06:00","created_by":"Stephen Nichols","updated_at":"2026-01-21T14:53:30.826469185-06:00","closed_at":"2026-01-21T14:53:30.826469185-06:00","close_reason":"Completed by agent","labels":["ralph","task"],"dependencies":[{"issue_id":"binance-withdrawal-m2e.2","depends_on_id":"binance-withdrawal-m2e","type":"parent-child","created_at":"2026-01-21T14:38:42.21844102-06:00","created_by":"Stephen Nichols"}]}
{"id":"binance-withdrawal-m2e.3","title":"US-4: Destination Configuration","description":"As an operator, I want to configure destination addresses per sub-account and asset so that funds are forwarded to the correct external wallets.\n\n## Acceptance Criteria\n- [ ] Configuration maps sub-account email → asset → (address, network)\n- [ ] Unconfigured sub-accounts or assets result in FAILED status\n- [ ] Configuration changes do not require service restart (optional: hot reload)\n- [ ] go build ./... passes\n- [ ] go test ./... passes","status":"closed","priority":1,"issue_type":"task","owner":"snichols@therealm.io","created_at":"2026-01-21T14:38:47.366301018-06:00","created_by":"Stephen Nichols","updated_at":"2026-01-21T14:57:30.492226085-06:00","closed_at":"2026-01-21T14:57:30.492226085-06:00","close_reason":"Completed by agent","labels":["ralph","task"],"dependencies":[{"issue_id":"binance-withdrawal-m2e.3","depends_on_id":"binance-withdrawal-m2e","type":"parent-child","created_at":"2026-01-21T14:38:47.367478745-06:00","created_by":"Stephen Nichols"}]}
{"id":"binance-withdrawal-m2e.4","title":"US-1: Transfer Detection via WebSocket","description":"As the withdrawal service, I want to detect incoming sub-account transfers in real-time via Binance's User Data Stream so that funds are forwarded with minimal latency.\n\n## Acceptance Criteria\n- [ ] Service obtains listen key via POST /sapi/v1/userDataStream\n- [ ] Connects to WebSocket at wss://stream.binance.com:9443/ws/{listenKey}\n- [ ] Refreshes listen key every 30 minutes\n- [ ] Processes balanceUpdate events to detect incoming transfers\n- [ ] Queries transfer history for full transfer details including tranId\n- [ ] go build ./... passes\n- [ ] go test ./... passes","status":"closed","priority":2,"issue_type":"task","owner":"snichols@therealm.io","created_at":"2026-01-21T14:38:54.330426202-06:00","created_by":"Stephen Nichols","updated_at":"2026-01-21T15:04:21.557688686-06:00","closed_at":"2026-01-21T15:04:21.557688686-06:00","close_reason":"Completed by agent","labels":["ralph","task"],"dependencies":[{"issue_id":"binance-withdrawal-m2e.4","depends_on_id":"binance-withdrawal-m2e","type":"parent-child","created_at":"2026-01-21T14:38:54.332522744-06:00","created_by":"Stephen Nichols"},{"issue_id":"binance-withdrawal-m2e.4","depends_on_id":"binance-withdrawal-m2e.1","type":"blocks","created_at":"2026-01-21T14:39:58.179392159-06:00","created_by":"Stephen Nichols"},{"issue_id":"binance-withdrawal-m2e.4","depends_on_id":"binance-withdrawal-m2e.2","type":"blocks","created_at":"2026-01-21T14:39:58.232896716-06:00","created_by":"Stephen Nichols"}]}
{"id":"binance-withdrawal-m2e.5","title":"US-2: Fallback Polling on Startup/Reconnect","description":"As the withdrawal service, I want to poll recent transfer history on startup and after WebSocket reconnection so that no transfers are missed during downtime.\n\n## Acceptance Criteria\n- [ ] On startup, query GET /sapi/v1/sub-account/transfer/subUserHistory with type=1\n- [ ] Use configurable lookback window (default 5 minutes)\n- [ ] Process any transfers not already in the local store\n- [ ] Same polling occurs after WebSocket reconnection\n- [ ] go build ./... passes\n- [ ] go test ./... passes","status":"closed","priority":2,"issue_type":"task","owner":"snichols@therealm.io","created_at":"2026-01-21T14:39:00.776576063-06:00","created_by":"Stephen Nichols","updated_at":"2026-01-21T15:08:32.728302662-06:00","closed_at":"2026-01-21T15:08:32.728302662-06:00","close_reason":"Completed by agent","labels":["ralph","task"],"dependencies":[{"issue_id":"binance-withdrawal-m2e.5","depends_on_id":"binance-withdrawal-m2e","type":"parent-child","created_at":"2026-01-21T14:39:00.777731848-06:00","created_by":"Stephen Nichols"},{"issue_id":"binance-withdrawal-m2e.5","depends_on_id":"binance-withdrawal-m2e.1","type":"blocks","created_at":"2026-01-21T14:40:02.082373845-06:00","created_by":"Stephen Nichols"},{"issue_id":"binance-withdrawal-m2e.5","depends_on_id":"binance-withdrawal-m2e.2","type":"blocks","created_at":"2026-01-21T14:40:02.130556443-06:00","created_by":"Stephen Nichols"}]}
{"id":"binance-withdrawal-m2e.6","title":"US-3: Idempotent Forward Processing","description":"As the withdrawal service, I want two-layer duplicate protection so that the same transfer is never forwarded twice.\n\n## Acceptance Criteria\n- [ ] Layer 1: Check BoltDB for tranId before processing (fast-path)\n- [ ] Layer 2: Query Binance withdrawal history by withdrawOrderId={tranId} before initiating\n- [ ] Set withdrawOrderId to tranId when initiating withdrawals\n- [ ] Handle BoltDB state loss gracefully via Binance query verification\n- [ ] go build ./... passes\n- [ ] go test ./... passes","status":"closed","priority":2,"issue_type":"task","owner":"snichols@therealm.io","created_at":"2026-01-21T14:39:06.686227908-06:00","created_by":"Stephen Nichols","updated_at":"2026-01-21T15:16:38.969976989-06:00","closed_at":"2026-01-21T15:16:38.969976989-06:00","close_reason":"Completed by agent","labels":["ralph","task"],"dependencies":[{"issue_id":"binance-withdrawal-m2e.6","depends_on_id":"binance-withdrawal-m2e","type":"parent-child","created_at":"2026-01-21T14:39:06.687291198-06:00","created_by":"Stephen Nichols"},{"issue_id":"binance-withdrawal-m2e.6","depends_on_id":"binance-withdrawal-m2e.1","type":"blocks","created_at":"2026-01-21T14:40:06.641824781-06:00","created_by":"Stephen Nichols"},{"issue_id":"binance-withdrawal-m2e.6","depends_on_id":"binance-withdrawal-m2e.2","type":"blocks","created_at":"2026-01-21T14:40:06.686864929-06:00","created_by":"Stephen Nichols"},{"issue_id":"binance-withdrawal-m2e.6","depends_on_id":"binance-withdrawal-m2e.3","type":"blocks","created_at":"2026-01-21T14:40:06.733309301-06:00","created_by":"Stephen Nichols"}]}
{"id":"binance-withdrawal-m2e.7","title":"US-7: Crash Recovery","description":"As the withdrawal service, I want to recover gracefully from crashes so that PENDING transfers are not lost or double-processed.\n\n## Acceptance Criteria\n- [ ] On startup, query BoltDB for PENDING records\n- [ ] For each PENDING record, check Binance withdrawal history by withdrawOrderId\n- [ ] If withdrawal exists: update to FORWARDED\n- [ ] If not found: proceed with withdrawal\n- [ ] go build ./... passes\n- [ ] go test ./... passes","status":"closed","priority":2,"issue_type":"task","owner":"snichols@therealm.io","created_at":"2026-01-21T14:39:11.650012947-06:00","created_by":"Stephen Nichols","updated_at":"2026-01-21T15:18:59.132113373-06:00","closed_at":"2026-01-21T15:18:59.132113373-06:00","close_reason":"Crash recovery implemented: RecoverPending queries PENDING records from BoltDB on startup and checks Binance withdrawal history by withdrawOrderId. If withdrawal exists, updates to FORWARDED; if not found, proceeds with withdrawal. All tests pass.","labels":["ralph","task"],"dependencies":[{"issue_id":"binance-withdrawal-m2e.7","depends_on_id":"binance-withdrawal-m2e","type":"parent-child","created_at":"2026-01-21T14:39:11.652275403-06:00","created_by":"Stephen Nichols"},{"issue_id":"binance-withdrawal-m2e.7","depends_on_id":"binance-withdrawal-m2e.1","type":"blocks","created_at":"2026-01-21T14:40:10.684378011-06:00","created_by":"Stephen Nichols"},{"issue_id":"binance-withdrawal-m2e.7","depends_on_id":"binance-withdrawal-m2e.6","type":"blocks","created_at":"2026-01-21T14:40:10.734055754-06:00","created_by":"Stephen Nichols"}]}
{"id":"binance-withdrawal-m2e.8","title":"US-8: WebSocket Reconnection","description":"As the withdrawal service, I want automatic WebSocket reconnection with backoff so that service recovers from network disruptions.\n\n## Acceptance Criteria\n- [ ] Detect WebSocket disconnection\n- [ ] Reconnect with exponential backoff (configurable initial delay, default 5s)\n- [ ] Obtain new listen key if expired\n- [ ] Poll transfer history from last known timestamp on reconnect\n- [ ] Resume WebSocket monitoring\n- [ ] go build ./... passes\n- [ ] go test ./... passes","status":"open","priority":2,"issue_type":"task","owner":"snichols@therealm.io","created_at":"2026-01-21T14:39:17.281488213-06:00","created_by":"Stephen Nichols","updated_at":"2026-01-21T14:39:17.281488213-06:00","labels":["ralph","task"],"dependencies":[{"issue_id":"binance-withdrawal-m2e.8","depends_on_id":"binance-withdrawal-m2e","type":"parent-child","created_at":"2026-01-21T14:39:17.282768883-06:00","created_by":"Stephen Nichols"},{"issue_id":"binance-withdrawal-m2e.8","depends_on_id":"binance-withdrawal-m2e.4","type":"blocks","created_at":"2026-01-21T14:40:14.723438912-06:00","created_by":"Stephen Nichols"},{"issue_id":"binance-withdrawal-m2e.8","depends_on_id":"binance-withdrawal-m2e.5","type":"blocks","created_at":"2026-01-21T14:40:14.773307095-06:00","created_by":"Stephen Nichols"}]}
{"id":"binance-withdrawal-m2e.9","title":"US-11: Error Handling - Transient Errors","description":"As the withdrawal service, I want to retry transient errors with exponential backoff so that temporary failures don't cause permanent loss.\n\n## Acceptance Criteria\n- [ ] Retry on: network timeouts, rate limits (429), service unavailable (503)\n- [ ] Use exponential backoff\n- [ ] Maximum 5 retry attempts\n- [ ] Track retry count in TransferRecord\n- [ ] go build ./... passes\n- [ ] go test ./... passes","status":"open","priority":2,"issue_type":"task","owner":"snichols@therealm.io","created_at":"2026-01-21T14:39:22.420684276-06:00","created_by":"Stephen Nichols","updated_at":"2026-01-21T14:39:22.420684276-06:00","labels":["ralph","task"],"dependencies":[{"issue_id":"binance-withdrawal-m2e.9","depends_on_id":"binance-withdrawal-m2e","type":"parent-child","created_at":"2026-01-21T14:39:22.421826174-06:00","created_by":"Stephen Nichols"},{"issue_id":"binance-withdrawal-m2e.9","depends_on_id":"binance-withdrawal-m2e.6","type":"blocks","created_at":"2026-01-21T14:40:18.395067988-06:00","created_by":"Stephen Nichols"}]}
